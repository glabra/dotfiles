#!/bin/sh
set -ue
umask 0027
export PATH='/bin:/usr/bin'
export LANG='C'
IFS=' 	
'

CONTAINER_KEY_DICTKEY='domestic.graphic.container_key'

print_usage () {
    local status=${1}
    printf 'Usage: %s [-d $HOME dir] [-o opts] tag entrypoint\n' "$0"
    exit $status
}

get_container_id () {
    printf '%s' `docker ps -ql --filter="label=${CONTAINER_KEY_DICTKEY}=${1}"`
}

get_container_ip () {
    printf '%s' `docker inspect --format='{{ .NetworkSettings.IPAddress }}' ${1}`
}

initialize_host () {
    local key=${1}
    local pid_fifo=${2}

    local jack_cli="netjack-${key}"
    local container_id=`get_container_id ${key}`

    test -z "${container_id}" && return
    local container_ip=`get_container_ip ${container_id}`

    xhost "+local:${container_ip}"

    jack_netsource -N ${jack_cli} -H ${container_ip} -I0 -O0 -i2 -o0 &

    sleep 0.1 # wait for jack_netsource initialized

    jack_connect ${jack_cli}:capture_1 system:playback_1
    jack_connect ${jack_cli}:capture_2 system:playback_2

    echo $! >> "${pid_fifo}"
}

finalize_host () {
    local fifo_netsrc_pid="${1}"

    local netsrc_pid=`cat "${fifo_netsrc_pid}"`

    test -n "${netsrc_pid}" && \
        kill "${netsrc_pid}"

    rm -f "${fifo_netsrc_pid}"
}

while getopts o:d:h opt; do
    case "${opt}" in
      o) opts="${opts:-} ${OPTARG}" ;;
      d) home="${OPTARG}" ;;
      h) print_usage 0 ;;
    [?]) print_usage 1 ;;
    esac
done
shift `expr ${OPTIND} - 1`

if test -z "${1:-}"; then
    print_usage 1
else
    tag=${1:-}
    shift 1
fi

entrypoint="${@:-}"

container_key=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`
jack_client_name="netjack-${container_key}"

fifo_netsrc_pid=`mktemp -u`
mkfifo -m 600 "${fifo_netsrc_pid}"

(
sleep 0.1 # wait for docker container initialized
initialize_host ${container_key} "${fifo_netsrc_pid}"
) &

docker run --rm \
    --volume='/tmp/.X11-unix:/tmp/.X11-unix' \
    --user="`id -u`:`id -g`" \
    --env="DISPLAY=unix$DISPLAY" \
    --env="HOME=${home:-/tmp}" \
    --label="${CONTAINER_KEY_DICTKEY}=${container_key}" \
    ${opts:-} ${tag} ${entrypoint}

finalize_host "${fifo_netsrc_pid}"

