#!/bin/sh
set -ue
umask 0027
export PATH='/bin:/usr/bin'
export LANG='C'
IFS=' 	
'

CONTAINER_KEY_DICTKEY='domestic.graphic.container_key'

die () {
    local status=${1}
    printf 'Usage: %s [-d $HOME dir] [-o opts] [-ph] tag entrypoint\n' "$0"
    exit $status
}

get_container_id () {
    printf '%s' `docker ps -ql --filter="label=${CONTAINER_KEY_DICTKEY}=${1}"`
}

get_container_ip () {
    printf '%s' `docker inspect --format='{{ .NetworkSettings.IPAddress }}' ${1}`
}

initialize_jack () {
    local key=${1}
    local info_fifo=${2}

    local container_id=`get_container_id ${key}`
    test -z "${container_id}" && return

    local jack_cli="netjack-${key}"
    local container_ip=`get_container_ip ${container_id}`

    jack_netsource -N ${jack_cli} -H ${container_ip} -I0 -O0 -i2 -o0 &

    sleep 0.1 # wait for jack_netsource initialized

    jack_connect ${jack_cli}:capture_1 system:playback_1
    jack_connect ${jack_cli}:capture_2 system:playback_2

    echo $! >> "jack_pid:${pid_fifo}"
}

finalize_jack () {
    local fifo_netsrc_pid="${1}"
    local netsrc_pid=`cat "${fifo_netsrc_pid}"`

    test -n "${netsrc_pid}" && kill "${netsrc_pid}"
    rm -f "${fifo_netsrc_pid}"
}

while getopts npho:d: opt; do
    case "${opt}" in
      o) opts="${opts:-} ${OPTARG}" ;;
      d) home="${OPTARG}" ;;
      p) privileged='true' ;;
      n) no_jack='true' ;;
      h) die 0 ;;
    [?]) die 1 ;;
    esac
done
shift `expr ${OPTIND} - 1`

test -z "${1:-}" && die 1

tag=${1:-}
shift 1
entrypoint="${@:-}"

container_key=`cat /dev/urandom | tr -dc A-Za-z0-9 | head -c 16`

if test -z "${no_jack:-}"; then
    fifo_netsrc_pid=`mktemp -u`

    (
    sleep 0.1 # wait for docker container initialized
    mkfifo -m 600 "${fifo_netsrc_pid}"
    initialize_jack ${container_key} "${fifo_netsrc_pid}"
    ) &

    trap "finalize_jack '${fifo_netsrc_pid}'" EXIT
fi

test -z "${privileged:-}" && \
    opts="${opts:-} --user='`id -u`:`id -g`'"

xhost local: # bypass MIT-COOKIE authentication
docker run --rm \
    --volume='/tmp/.X11-unix:/tmp/.X11-unix' \
    --env="DISPLAY" \
    --env="HOME=${home:-/tmp}" \
    --label="${CONTAINER_KEY_DICTKEY}=${container_key}" \
    ${opts:-} ${tag} ${entrypoint}

