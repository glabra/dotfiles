#!/bin/sh
set -u
set -e
umask 0750
export PATH="/bin:/usr/bin"
export LANG="C"
IFS="	 
"

BAT_TRESHOLD=5

# _get_battery BATn (full|now)
_get_battery () {
  local value=`cat /sys/class/power_supply/${1}/energy_${2} 2> /dev/null`
  if test -z "${value}"
  then
    printf '%s' '0'
  else
    printf '%s' "${value}"
  fi
}

if test "`cat /sys/class/power_supply/AC/online`" -eq 1
then
  charge_status='o'
else
  charge_status='x'
fi

bat_full=$(( `_get_battery BAT0 full` + `_get_battery BAT1 full` ))
bat_now=$(( `_get_battery BAT0 now` + `_get_battery BAT1 now` ))

if test "${bat_full}" -gt 0
then
  bat_percent=$(( bat_now * 100 / bat_full ))
else
  bat_percent=0
fi

if test "$#" -gt 0 \
   && test "$1" = '--with-notify' \
   && test -n "${bat_percent}" \
   && test "${bat_percent}" -lt "${BAT_TRESHOLD}" \
   && test "${charge_status}" = 'x'
then
  notify-send -u critical "Critical low-battery" "Battery remains less than ${BAT_TRESHOLD} percents."
fi

printf '%s' "${charge_status}${bat_percent}%"

