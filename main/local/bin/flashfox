#!/bin/sh
set -ue
umask 0027
export LANG='C'
IFS=' 	
'

IMAGE='flashfox'

print_usage () {
    local status=${1}
    printf 'Usage: %s [-p profile dir] url\n' "$0"
    exit $status
}

initialize_profile () {
    local veilbase=$1
    local profile=$2

    # mount dirs
    for d in 'up' 'work' 'merged'; do
        mkdir "${veilbase}/${d}"
    done

    # construct opts
    local opts='rw,noatime'
    opts="${opts},lowerdir=${profile}"
    opts="${opts},upperdir=${veilbase}/up"
    opts="${opts},workdir=${veilbase}/work"

    local target="${veilbase}/merged"
    sudo mount -t overlay overlay -o "${opts}" "${target}"

    printf '%s' "$target"
}

finalize_profile () {
    local veilbase=$1
    local merged=$2

    sudo umount "${merged}"
    rm -rf "${veilbase}"
}

profile="${HOME}/.mozilla"

while getopts p:h opt; do
    case "${opt}" in
      p) profile="${OPTARG}" ;;
      h) print_usage 0 ;;
    [?]) print_usage 1 ;;
    esac
done
shift `expr ${OPTIND} - 1`

veilbase=`mktemp -d`
target_url=${1:-about:blank}

mirror=`initialize_profile "${veilbase}" "${profile}"`

docker-run-gui -d'/tmp' \
    -o"--volume=${mirror}:/tmp/.mozilla" \
    ${IMAGE} --private-window ${target_url}

finalize_profile "${veilbase}" "${mirror}"

