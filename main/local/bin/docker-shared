#!/bin/sh
set -ue
umask 0027
export PATH='/bin:/usr/bin'
export LANG='C'
IFS=' 	
'

print_usage () {
    local status=${1}
    printf 'Usage: %s [-o opts] [-d sharedir] [-D homedir] [-ph] tag entrypoint\n' "$0"
    exit $status
}

print_info () {
    printf 'Running %s\n' "${tag}"
    printf '%s -> /mnt\n' "${share_dir}"
    printf '\n'
}

share_dir=`pwd`

while getopts hpd:D:o: opt; do
    case "${opt}" in
      d) share_dir="${OPTARG}" ;;
      D) home_dir="${OPTARG}" ;;
      o) opts="${opts} ${OPTARG}" ;;
      p) privileged='true' ;;
      h) print_usage 0 ;;
    [?]) print_usage 1 ;;
    esac
done
shift `expr ${OPTIND} - 1`

tag="${1:-alpine:edge}"
shift 1
entrypoint="${@:-/bin/ash}"

test -z "${privileged:-}" && \
    opts="${opts:-} --user='`id -u`:`id -g`'"

print_info

docker run --rm -ti \
    --env="HOME=${home:-/tmp}" \
    --volume=${share_dir}:/mnt \
    ${opts:-} ${tag} ${entrypoint}
