#!/bin/sh
set -ue
umask 0750
export PATH="/bin:/usr/bin"
export LANG="C"
IFS="	 
"

_get_battery () {
    local pow=$(upower -i /org/freedesktop/UPower/devices/battery_${1} | grep percent | egrep -o '[0-9]+')

    printf '%s' "${pow:-0}"
}

battery () {
  local charge_status='x'
  local bat_full=0
  local bat_now=0
  local bat_ratio='?'


  local isCharged="$(upower -i /org/freedesktop/UPower/devices/line_power_AC | grep online | egrep -o '[a-z]+$')"
  if [[ "$isCharged" = 'yes' ]]; then
    charge_status='o'
  fi

  bat_ratio=$(( ( $(_get_battery BAT0) + $(_get_battery BAT1) ) / 2 ))

  printf '%s' "${charge_status}${bat_ratio}%"
}

dwm_update_status () {
  local str=''
  local audio_status=`amixer get Master | tail -n 1`
  local audio_level=`echo "${audio_status}" | egrep -o '[0-9]+%'`
  local mute_indicator='-'

  if echo "${audio_status}" | grep -q '\[on\]$'; then
    mute_indicator='+'
  fi
  str="v:${mute_indicator}${audio_level}"

  light_level=`xbacklight -get | egrep -o '^[0-9]+'`
  str="${str} l:${light_level}%"

  battery_status=`battery`
  str="${str} r:${battery_status}"

  date=`date +'%H:%M:%S'`
  str="${str} ${date}"

  xsetroot -name "${str}"
}

if [ "${1:-}" = 'eternal' ]; then
	while true; do
		dwm_update_status
		sleep 0.2
	done
else
	dwm_update_status
fi
