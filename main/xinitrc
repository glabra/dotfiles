#!/bin/sh

if test -d /etc/X11/xinit/xinitrc.d
then
   for file in /etc/X11/xinit/xinitrc.d/*
   do
      test -x "${file}" && . "${file}"
   done
   unset file
fi

export LANG='ja_JP.UTF-8'
printf '%s' "${PATH}" | fgrep -q "${HOME}/.local/bin" \
	|| export PATH="${HOME}/.local/bin:${PATH}"

# keyboard settings
xset r rate 200 45
setxkbmap -option ctrl:swapcaps

# ime
if type fcitx-autostart >/dev/null 2>&1; then
	export XMODIFIERS=@im=fcitx
	export QT_IM_MODULE=fcitx
	export GTK_IM_MODULE=fcitx
	fcitx-autostart &
fi

# hack for beautiful looking in Java, avoid Java AWT bugs
export _JAVA_OPTIONS='-Dswing.defaultlaf=com.sun.java.swing.plaf.gtk.GTKLookAndFeel -Dawt.useSystemAAFontSettings=gasp'
export _JAVA_AWT_WM_NONREPARENTING=1
export AWT_TOOLKIT=MToolkit
type wmname >/dev/null 2>&1 && wmname LG3D

# mute HDMI2 sound
amixer sset 'IEC958,1' mute

# display calibration
## for xiaomi mi notebook air 13, sharp:
##   https://github.com/tlvince/xiaomi-mi-notebook-air-13
calibration_profile="${HOME}/.config/6500k.icm"
[ -f "${calibration_profile}" ] \
	&& type dispwin >/dev/null 2>&1 \
	&& dispwin -d1 "${calibration_profile}"
unset calibration_profile

__run_singleton () {
	local pids=$(ps ax | fgrep "$*" | cut -d' ' -f1)
	[ -n "${pids}" ] && kill ${pids}
	"$@" &
}

# compositor
type compton >/dev/null 2>&1 \
	&& [ -f "${HOME}/.config/compton.conf" ] \
	&& compton --config "${HOME}/.config/compton.conf" --daemon

# dwm statusbar
type dwm-statusline >/dev/null 2>&1 && \
	__run_singleton dwm-statusline

# wallpaper
type feh >/dev/null 2>&1 \
	&& [ -f "${HOME}/.local/wallpaper.jpg" ] \
	&& feh --bg-fill "${HOME}/.local/wallpaper.jpg"

exec dwm
