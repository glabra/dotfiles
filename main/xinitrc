#!/bin/sh

if test -d /etc/X11/xinit/xinitrc.d
then
   for file in /etc/X11/xinit/xinitrc.d/*
   do
      test -x "${file}" && . "${file}"
   done
   unset file
fi

export LANG='ja_JP.UTF-8'

printf '%s' "${PATH}" | fgrep -q "${HOME}/.local/bin" \
	|| export PATH="${HOME}/.local/bin:${PATH}"

printf '%s' "${PATH}" | fgrep -q "${HOME}/.local/bin" \
	|| export PATH="${HOME}/.local/bin:${PATH}"

# keyboard settings
xset r rate 200 45
setxkbmap -option ctrl:nocaps

# ime
if type fcitx-autostart >/dev/null 2>&1; then
	export XMODIFIERS=@im=fcitx
	export QT_IM_MODULE=fcitx
	export GTK_IM_MODULE=fcitx
	fcitx-autostart &
fi

# hack for beautiful looking in Java, avoid Java AWT bugs
export _JAVA_OPTIONS='-Dswing.defaultlaf=com.sun.java.swing.plaf.gtk.GTKLookAndFeel -Dawt.useSystemAAFontSettings=gasp'
export _JAVA_AWT_WM_NONREPARENTING=1
export AWT_TOOLKIT=MToolkit
[ "$(command -v wmname)" ] && wmname LG3D

# display calibration
## for xiaomi mi notebook air 13, sharp:
##   https://github.com/tlvince/xiaomi-mi-notebook-air-13
calibration_profile="${HOME}/.config/6500k.icm"
[ "$(command -v dispwin)" -a -f "${calibration_profile}" ] \
	&& dispwin -d1 "${calibration_profile}"
unset calibration_profile

__run_singleton () {
	local pids=$(ps ax | fgrep "$*" | cut -d' ' -f1)
	[ -n "${pids}" ] && kill ${pids}
	"$@" &
}

# compositor
[ "$(command -v compton)" -a -f "${HOME}/.config/compton.conf" ] \
	&& compton --config "${HOME}/.config/compton.conf" --daemon

# pee display
[ "$(command -v redshift)" ] \
	&& __run_singleton redshift

# dwm statusbar
[ "$(command -v dwm-statusline)" ] \
	&& __run_singleton dwm-statusline forever

# autostart keepassxc
[ "$(command -v keepassxc)" ] \
	&& keepassxc &

# wallpaper
[ "$(command -v feh)" -a -f "${HOME}/.local/wallpaper.jpg" ] \
	&& ( sleep 0.1; feh --bg-fill "${HOME}/.local/wallpaper.jpg" ) &

exec dwm
